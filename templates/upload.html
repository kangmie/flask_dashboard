{% extends "base.html" %}

{% block title %}Upload Data - Multi-Branch Analytics{% endblock %}

{% block page_title %}üìÅ Upload Data Multi-Branch{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item active">Upload Data</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üì§ Upload File Excel Multi-Branch</h5>
            </div>
            <div class="chart-body">
                <!-- Upload Instructions -->
                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i>Instruksi Upload:</h6>
                    <ul class="mb-0">
                        <li>Upload satu file Excel (.xlsx/.xls) per cabang</li>
                        <li>Nama cabang harus berada di cell A2</li>
                        <li>Header kolom harus berada di baris 14 (A14-O14)</li>
                        <li>Data dimulai dari baris 15 (A15-O15 dst)</li>
                        <li>Maksimal ukuran file: 50MB per file</li>
                    </ul>
                </div>
                
                <!-- Upload Form -->
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: var(--primary-color);"></i>
                        <h5>Drag & Drop Files atau Klik untuk Browse</h5>
                        <p class="text-muted">Pilih multiple file Excel dari berbagai cabang</p>
                        <input type="file" 
                               id="fileInput" 
                               name="files[]" 
                               multiple 
                               accept=".xlsx,.xls"
                               style="display: none;">
                        <button type="button" class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Browse Files
                        </button>
                    </div>
                    
                    <!-- Selected Files List -->
                    <div id="selectedFiles" class="mt-4" style="display: none;">
                        <h6><i class="fas fa-list me-2"></i>File yang Dipilih:</h6>
                        <div id="filesList" class="list-group"></div>
                        <div class="text-muted mt-2">
                            <small>Tips: Pastikan setiap file memiliki nama cabang unik di cell A2</small>
                        </div>
                    </div>
                    
                    <!-- Upload Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled>
                            <i class="fas fa-upload me-2"></i>Upload & Proses Data
                        </button>
                        <div class="text-muted mt-2">
                            <small>Setelah upload berhasil, Anda akan diarahkan ke Dashboard</small>
                        </div>
                    </div>
                </form>
                
                <!-- Progress Bar -->
                <div id="uploadProgress" class="mt-4" style="display: none;">
                    <h6>Processing Files...</h6>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%"></div>
                    </div>
                    <div class="upload-status" id="uploadStatus">
                        <p class="mt-2 text-muted" id="progressText">Preparing upload...</p>
                        <div id="uploadSteps" class="mt-3">
                            <div class="step-item" id="step1">
                                <i class="fas fa-clock text-secondary me-2"></i>
                                <span>Mengupload files...</span>
                            </div>
                            <div class="step-item" id="step2" style="display: none;">
                                <i class="fas fa-cog fa-spin text-primary me-2"></i>
                                <span>Memproses data Excel...</span>
                            </div>
                            <div class="step-item" id="step3" style="display: none;">
                                <i class="fas fa-chart-bar text-info me-2"></i>
                                <span>Menyiapkan analisis...</span>
                            </div>
                            <div class="step-item" id="step4" style="display: none;">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span>Upload berhasil! Mengarahkan ke Dashboard...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sample Data Format -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üìã Format Data yang Diharapkan</h5>
            </div>
            <div class="chart-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-table me-2"></i>Struktur File Excel:</h6>
                        <ul>
                            <li><strong>Cell A2:</strong> Nama Cabang (contoh: "Ramen Master Yogyakarta")</li>
                            <li><strong>Baris 14:</strong> Header kolom (A14-O14)</li>
                            <li><strong>Baris 15+:</strong> Data penjualan</li>
                        </ul>
                        
                        <h6 class="mt-4"><i class="fas fa-columns me-2"></i>Kolom yang Diperlukan:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Kolom</th>
                                        <th>Nama Field</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>A</td><td>Sales Number</td></tr>
                                    <tr><td>B</td><td>Sales Date</td></tr>
                                    <tr><td>C</td><td>Sales Type</td></tr>
                                    <tr><td>D</td><td>Branch</td></tr>
                                    <tr><td>E</td><td>Menu</td></tr>
                                    <tr><td>F</td><td>Menu Code</td></tr>
                                    <tr><td>G</td><td>Menu Category</td></tr>
                                    <tr><td>H</td><td>Menu Category Detail</td></tr>
                                    <tr><td>I</td><td>Qty</td></tr>
                                    <tr><td>J</td><td>Price</td></tr>
                                    <tr><td>K</td><td>Total</td></tr>
                                    <tr><td>L</td><td>Discount Total</td></tr>
                                    <tr><td>M</td><td>COGS Total</td></tr>
                                    <tr><td>N</td><td>COGS Total (%)</td></tr>
                                    <tr><td>O</td><td>Margin</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-check-circle me-2"></i>Tips untuk Upload Sukses:</h6>
                        <div class="alert alert-success">
                            <ul class="mb-0">
                                <li>Pastikan nama cabang di A2 unik untuk setiap file</li>
                                <li>Format tanggal harus konsisten</li>
                                <li>Kolom numerik (Qty, Price, Total, dll) harus berisi angka</li>
                                <li>Jangan ada baris kosong di tengah data</li>
                                <li>Nama menu dan kategori harus lengkap</li>
                            </ul>
                        </div>
                        
                        <h6 class="mt-4"><i class="fas fa-exclamation-triangle me-2"></i>Troubleshooting:</h6>
                        <div class="alert alert-warning">
                            <ul class="mb-0">
                                <li>Jika upload gagal, cek format tanggal dan data numerik</li>
                                <li>Pastikan file tidak corrupt atau password protected</li>
                                <li>Coba upload satu file dulu untuk test</li>
                                <li>Maksimal 20 file dalam sekali upload</li>
                            </ul>
                        </div>
                        
                        <!-- Success Message Note -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-route me-2"></i>Setelah Upload Berhasil:</h6>
                            <ul class="mb-0">
                                <li>Anda akan otomatis diarahkan ke <strong>Dashboard</strong></li>
                                <li>Data dari semua cabang akan digabung dan dianalisis</li>
                                <li>Semua menu analisis akan tersedia</li>
                                <li>File sementara akan otomatis dihapus dari server</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions for Existing Data -->
{% if analyzer %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6><i class="fas fa-database me-2"></i>Data sudah tersedia!</h6>
                    <p class="mb-0">Anda sudah memiliki data yang dimuat. Apakah ingin kembali ke Dashboard atau upload data baru?</p>
                </div>
                <div>
                    <a href="{{ url_for('index') }}" class="btn btn-success me-2">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </a>
                    <button class="btn btn-outline-warning" onclick="if(confirm('Upload data baru akan mengganti data yang ada. Lanjutkan?')) { window.location.reload(); }">
                        <i class="fas fa-refresh me-1"></i>Data Baru
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .file-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: between;
        align-items: center;
        transition: all 0.3s ease;
    }
    
    .file-item:hover {
        background: #e9ecef;
        border-color: var(--primary-color);
    }
    
    .file-item .file-info {
        display: flex;
        align-items: center;
        flex-grow: 1;
    }
    
    .file-item .file-icon {
        color: var(--success-color, #28a745);
        margin-right: 12px;
        font-size: 1.2rem;
    }
    
    .file-item .file-details strong {
        color: var(--primary-color, #005A5B);
    }
    
    .file-item .remove-file {
        color: var(--danger-color, #dc3545);
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.3s ease;
        margin-left: 10px;
    }
    
    .file-item .remove-file:hover {
        background: #f8d7da;
        color: #721c24;
        transform: scale(1.1);
    }
    
    .upload-area.dragover {
        border-color: var(--accent-color, #20B2AA) !important;
        background: #e8f5f5 !important;
        transform: scale(1.02);
    }
    
    .upload-area {
        transition: all 0.3s ease;
    }
    
    .step-item {
        padding: 8px 0;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    .step-item.active {
        font-weight: 600;
        color: var(--primary-color, #005A5B);
    }
    
    .progress {
        height: 8px;
        border-radius: 6px;
        overflow: hidden;
        background-color: #e9ecef;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, var(--primary-color, #005A5B) 0%, var(--secondary-color, #008B8B) 100%);
        transition: width 0.6s ease;
    }
    
    .upload-status {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid var(--primary-color, #005A5B);
    }
    
    .btn-lg {
        padding: 12px 30px;
        font-size: 1.1rem;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        margin-bottom: 30px;
        overflow: hidden;
        border: 1px solid #e9ecef;
        transition: box-shadow 0.3s ease;
    }
    
    .chart-card:hover {
        box-shadow: 0 4px 25px rgba(0,0,0,0.12);
    }
    
    .chart-header {
        background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px 25px;
        border-bottom: 2px solid var(--primary-color, #005A5B);
    }
    
    .chart-title {
        margin: 0;
        color: var(--primary-color, #005A5B);
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .alert {
        border-radius: 8px;
        border: none;
        padding: 15px 20px;
        margin-bottom: 20px;
    }
    
    .alert h6 {
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    @media (max-width: 768px) {
        .file-item {
            flex-direction: column;
            align-items: stretch;
            padding: 12px;
        }
        
        .file-item .file-info {
            margin-bottom: 10px;
        }
        
        .file-item .remove-file {
            align-self: center;
            margin-left: 0;
        }
        
        .btn-lg {
            padding: 10px 20px;
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Upload page loaded');
    
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const selectedFiles = document.getElementById('selectedFiles');
    const filesList = document.getElementById('filesList');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadForm = document.getElementById('uploadForm');
    
    let filesArray = [];
    
    // Click to browse
    uploadArea.addEventListener('click', function(e) {
        if (e.target === uploadArea || e.target.tagName === 'I' || e.target.tagName === 'H5' || e.target.tagName === 'P') {
            fileInput.click();
        }
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });
    
    function handleFiles(files) {
        // Filter Excel files
        const excelFiles = files.filter(file => {
            const extension = file.name.split('.').pop().toLowerCase();
            return ['xlsx', 'xls'].includes(extension);
        });
        
        if (excelFiles.length === 0) {
            alert('Silakan pilih file Excel (.xlsx atau .xls)');
            return;
        }
        
        // Validate file size
        const oversizedFiles = excelFiles.filter(file => file.size > 50 * 1024 * 1024);
        if (oversizedFiles.length > 0) {
            alert(`File terlalu besar: ${oversizedFiles.map(f => f.name).join(', ')}. Maksimal 50MB per file.`);
            return;
        }
        
        // Add to files array
        excelFiles.forEach(file => {
            // Check if file already exists
            const exists = filesArray.some(f => f.name === file.name && f.size === file.size);
            if (!exists) {
                filesArray.push(file);
            }
        });
        
        updateFilesList();
        updateUploadButton();
    }
    
    function updateFilesList() {
        if (filesArray.length === 0) {
            selectedFiles.style.display = 'none';
            return;
        }
        
        selectedFiles.style.display = 'block';
        filesList.innerHTML = '';
        
        filesArray.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            const isOversized = file.size > 50 * 1024 * 1024;
            
            fileItem.innerHTML = `
                <div class="file-info">
                    <i class="fas fa-file-excel file-icon"></i>
                    <div class="file-details">
                        <strong>${file.name}</strong>
                        <br>
                        <small class="text-muted">${fileSize} MB ${isOversized ? '(Terlalu besar!)' : ''}</small>
                    </div>
                </div>
                <i class="fas fa-times remove-file" onclick="removeFile(${index})" title="Remove file"></i>
            `;
            
            if (isOversized) {
                fileItem.style.borderColor = '#dc3545';
                fileItem.style.backgroundColor = '#f8d7da';
            }
            
            filesList.appendChild(fileItem);
        });
    }
    
    window.removeFile = function(index) {
        filesArray.splice(index, 1);
        updateFilesList();
        updateUploadButton();
        updateFileInput();
    }
    
    function updateFileInput() {
        // Create new FileList
        const dt = new DataTransfer();
        filesArray.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }
    
    function updateUploadButton() {
        const validFiles = filesArray.filter(file => file.size <= 50 * 1024 * 1024);
        uploadBtn.disabled = validFiles.length === 0;
        
        if (filesArray.length > validFiles.length) {
            uploadBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Ada file yang terlalu besar';
            uploadBtn.className = 'btn btn-warning btn-lg';
        } else if (validFiles.length > 0) {
            uploadBtn.innerHTML = `<i class="fas fa-upload me-2"></i>Upload ${validFiles.length} File${validFiles.length > 1 ? 's' : ''}`;
            uploadBtn.className = 'btn btn-primary btn-lg';
        } else {
            uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload & Proses Data';
            uploadBtn.className = 'btn btn-primary btn-lg';
        }
    }
    
    // Form submission with enhanced progress tracking
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const validFiles = filesArray.filter(file => file.size <= 50 * 1024 * 1024);
        
        if (validFiles.length === 0) {
            alert('Silakan pilih file yang valid untuk diupload');
            return;
        }
        
        // Show progress
        uploadProgress.style.display = 'block';
        uploadBtn.disabled = true;
        uploadArea.style.opacity = '0.5';
        
        // Update step 1
        updateUploadStep(1, 'active');
        
        // Create FormData with valid files only
        const formData = new FormData();
        validFiles.forEach(file => {
            formData.append('files[]', file);
        });
        
        // Upload with enhanced progress tracking
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                const progressBar = document.querySelector('.progress-bar');
                const progressText = document.getElementById('progressText');
                
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = `Uploading ${validFiles.length} file${validFiles.length > 1 ? 's' : ''}... ${Math.round(percentComplete)}%`;
                
                // Update steps based on progress
                if (percentComplete >= 25 && percentComplete < 75) {
                    updateUploadStep(1, 'completed');
                    updateUploadStep(2, 'active');
                } else if (percentComplete >= 75 && percentComplete < 95) {
                    updateUploadStep(2, 'completed');
                    updateUploadStep(3, 'active');
                } else if (percentComplete >= 95) {
                    updateUploadStep(3, 'completed');
                    updateUploadStep(4, 'active');
                }
            }
        });
        
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                // Success
                updateUploadStep(4, 'completed');
                document.getElementById('progressText').textContent = 'Upload berhasil! Mengarahkan ke Dashboard...';
                
                // Small delay to show success message
                setTimeout(() => {
                    // The server will handle the redirect, but we can also do it here as backup
                    if (!window.location.href.includes('/upload')) {
                        window.location.href = "{{ url_for('index') }}";
                    }
                }, 1500);
            } else {
                // Error
                handleUploadError('Upload failed. Server returned error: ' + xhr.status);
            }
        });
        
        xhr.addEventListener('error', function() {
            handleUploadError('Upload failed. Please check your connection and try again.');
        });
        
        xhr.addEventListener('timeout', function() {
            handleUploadError('Upload timeout. Please try again with smaller files.');
        });
        
        // Set timeout for large files
        xhr.timeout = 300000; // 5 minutes
        
        xhr.open('POST', '{{ url_for("upload_files") }}');
        xhr.send(formData);
    });
    
    function updateUploadStep(stepNumber, status) {
        const step = document.getElementById(`step${stepNumber}`);
        if (!step) return;
        
        const icon = step.querySelector('i');
        const text = step.querySelector('span');
        
        // Reset classes
        icon.className = icon.className.replace(/text-\w+/g, '').replace(/fa-\w+/g, '');
        step.style.display = 'block';
        
        switch (status) {
            case 'active':
                icon.className += ' fas fa-cog fa-spin text-primary';
                step.classList.add('active');
                break;
            case 'completed':
                icon.className += ' fas fa-check-circle text-success';
                step.classList.remove('active');
                break;
            case 'error':
                icon.className += ' fas fa-times-circle text-danger';
                step.classList.remove('active');
                break;
        }
    }
    
    function handleUploadError(message) {
        console.error('Upload error:', message);
        
        // Reset UI
        uploadProgress.style.display = 'none';
        uploadBtn.disabled = false;
        uploadArea.style.opacity = '1';
        
        // Show error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alertDiv.innerHTML = `
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Upload Gagal</h6>
            <p class="mb-2">${message}</p>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="window.location.reload()">
                    <i class="fas fa-refresh me-1"></i>Coba Lagi
                </button>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Insert after upload form
        uploadForm.parentNode.insertBefore(alertDiv, uploadForm.nextSibling);
        
        // Auto dismiss after 10 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 10000);
    }
    
    // Initialize
    updateUploadButton();
    
    console.log('‚úÖ Upload functionality initialized');
});
</script>
{% endblock %}