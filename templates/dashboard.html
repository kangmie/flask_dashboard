{% extends "base.html" %}

{% block title %}Dashboard - Multi-Branch Analytics{% endblock %}

{% block content %}
<h1>üìä Dashboard Overview</h1>

<!-- Key Metrics Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Total Branches</h5>
                        <h3>{{ summary_stats.total_branches if summary_stats else 0 }}</h3>
                    </div>
                    <div>
                        <i class="fas fa-building fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Total Revenue</h5>
                        <h3>{{ total_revenue if total_revenue else "Rp 0" }}</h3>
                    </div>
                    <div>
                        <i class="fas fa-money-bill-wave fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Total Margin</h5>
                        <h3>{{ total_margin if total_margin else "Rp 0" }}</h3>
                    </div>
                    <div>
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Gross Margin %</h5>
                        <h3>{{ gross_margin_pct if gross_margin_pct else "0%" }}</h3>
                    </div>
                    <div>
                        <i class="fas fa-percentage fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Metrics Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Total Transaksi</h5>
                        <h3>{{ summary_stats.total_transactions | number if summary_stats else 0 }}</h3>
                    </div>
                    <div>
                        <i class="fas fa-receipt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-dark text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Produk Unik</h5>
                        <h3>{{ summary_stats.unique_products | number if summary_stats else 0 }}</h3>
                    </div>
                    <div>
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card" style="background: linear-gradient(135deg, #DC143C 0%, #B22222 100%); color: white;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Avg COGS %</h5>
                        <h3>{{ (summary_stats.avg_cogs_percentage | round(1)) if summary_stats else 0 }}%</h3>
                    </div>
                    <div>
                        <i class="fas fa-calculator fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card" style="background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%); color: white;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Avg per Transaksi</h5>
                        <h3>{{ summary_stats.avg_transaction_value | currency if summary_stats else "Rp 0" }}</h3>
                    </div>
                    <div>
                        <i class="fas fa-calendar-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
{% if charts_data %}
<div class="row mb-4">
    {% if charts_data.revenue_bar %}
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5>üìä Revenue per Cabang (Top 10)</h5>
            </div>
            <div class="card-body">
                <div id="revenue-bar-chart"></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if charts_data.revenue_pie %}
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5>ü•ß Distribusi Revenue per Cabang</h5>
            </div>
            <div class="card-body">
                <div id="revenue-pie-chart"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    {% if charts_data.top_products %}
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5>üçú Top 10 Produk by Revenue</h5>
            </div>
            <div class="card-body">
                <div id="top-products-chart"></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if charts_data.performance_matrix %}
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5>üíé Matrix Performa Cabang</h5>
            </div>
            <div class="card-body">
                <div id="performance-matrix-chart"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Branch Performance Table -->
{% if branch_comparison is defined and branch_comparison is not none %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>üèÜ Ranking Performa Cabang</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Cabang</th>
                                <th>Total Revenue</th>
                                <th>Margin %</th>
                                <th>COGS %</th>
                                <th>Transaksi</th>
                                <th>Avg/Transaksi</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(branch_comparison|length) %}
                                {% set branch = branch_comparison.iloc[i] %}
                                <tr>
                                    <td>
                                        <span class="badge bg-primary">{{ branch.Revenue_Rank }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ branch.Branch[:30] }}{% if branch.Branch|length > 30 %}...{% endif %}</strong>
                                    </td>
                                    <td>{{ branch.Total_Revenue | currency }}</td>
                                    <td>
                                        {% set margin_pct = branch.Margin_Percentage %}
                                        {% if margin_pct > 25 %}
                                            <span class="badge bg-success">{{ margin_pct | percentage }}</span>
                                        {% elif margin_pct > 20 %}
                                            <span class="badge bg-info">{{ margin_pct | percentage }}</span>
                                        {% elif margin_pct > 15 %}
                                            <span class="badge bg-warning">{{ margin_pct | percentage }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ margin_pct | percentage }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set cogs_pct = branch.COGS_Percentage %}
                                        {% if cogs_pct < 30 %}
                                            <span class="badge bg-success">{{ cogs_pct | percentage }}</span>
                                        {% elif cogs_pct < 40 %}
                                            <span class="badge bg-info">{{ cogs_pct | percentage }}</span>
                                        {% elif cogs_pct < 50 %}
                                            <span class="badge bg-warning">{{ cogs_pct | percentage }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ cogs_pct | percentage }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ branch.Transaction_Count | number }}</td>
                                    <td>{{ branch.Avg_Transaction | currency }}</td>
                                    <td>
                                        {% set rank = branch.Revenue_Rank %}
                                        {% set total_branches = summary_stats.total_branches if summary_stats else 5 %}
                                        {% if rank <= 3 %}
                                            <span class="badge bg-success">Top Performer</span>
                                        {% elif rank <= (total_branches // 2) %}
                                            <span class="badge bg-info">Above Average</span>
                                        {% elif rank <= (total_branches * 0.8) %}
                                            <span class="badge bg-warning">Average</span>
                                        {% else %}
                                            <span class="badge bg-danger">Needs Attention</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>üöÄ Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('branch_comparison') }}" class="btn btn-primary w-100">
                            <i class="fas fa-building me-2"></i>Analisis Cabang Detail
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('product_analysis') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-boxes me-2"></i>Analisis Produk
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('cogs_analysis') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-calculator me-2"></i>Optimasi COGS
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('chat') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-robot me-2"></i>Chat dengan AI
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Revenue Bar Chart
    {% if charts_data and charts_data.revenue_bar %}
    try {
        const revenueBarData = {{ charts_data.revenue_bar | safe }};
        Plotly.newPlot('revenue-bar-chart', revenueBarData.data, revenueBarData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (error) {
        console.error('Error loading revenue bar chart:', error);
    }
    {% endif %}
    
    // Revenue Pie Chart
    {% if charts_data and charts_data.revenue_pie %}
    try {
        const revenuePieData = {{ charts_data.revenue_pie | safe }};
        Plotly.newPlot('revenue-pie-chart', revenuePieData.data, revenuePieData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (error) {
        console.error('Error loading revenue pie chart:', error);
    }
    {% endif %}
    
    // Top Products Chart
    {% if charts_data and charts_data.top_products %}
    try {
        const topProductsData = {{ charts_data.top_products | safe }};
        Plotly.newPlot('top-products-chart', topProductsData.data, topProductsData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (error) {
        console.error('Error loading top products chart:', error);
    }
    {% endif %}
    
    // Performance Matrix Chart
    {% if charts_data and charts_data.performance_matrix %}
    try {
        const performanceMatrixData = {{ charts_data.performance_matrix | safe }};
        Plotly.newPlot('performance-matrix-chart', performanceMatrixData.data, performanceMatrixData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (error) {
        console.error('Error loading performance matrix chart:', error);
    }
    {% endif %}
});
</script>
{% endblock %}