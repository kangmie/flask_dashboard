{% extends "base.html" %}

{% block title %}Sales by Time - Multi-Branch Analytics{% endblock %}

{% block page_title %}‚è∞ Sales by Time - Analisis Temporal{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item active">Sales by Time</li>
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-clock"></i>
            </div>
            {% if time_data.hourly is defined and not time_data.hourly.empty %}
                {% set peak_hours = time_data.hourly.loc[time_data.hourly.groupby('Branch')['Total'].idxmax()] %}
                {% if not peak_hours.empty %}
                    <div class="metric-value">{{ peak_hours['Hour'].mode().iloc[0] }}:00</div>
                {% else %}
                    <div class="metric-value">N/A</div>
                {% endif %}
            {% else %}
                <div class="metric-value">N/A</div>
            {% endif %}
            <div class="metric-label">Most Common Peak Hour</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%);">
            <div class="metric-icon">
                <i class="fas fa-calendar-day"></i>
            </div>
            {% if time_data.daily_pattern is defined and not time_data.daily_pattern.empty %}
                {% set daily_totals = time_data.daily_pattern.groupby('Day_of_Week')['Total_Revenue'].sum() %}
                {% if not daily_totals.empty %}
                    <div class="metric-value">{{ daily_totals.idxmax() }}</div>
                {% else %}
                    <div class="metric-value">N/A</div>
                {% endif %}
            {% else %}
                <div class="metric-value">N/A</div>
            {% endif %}
            <div class="metric-label">Best Day of Week</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-value">
                {% if time_data.hourly is defined and not time_data.hourly.empty %}
                    {{ time_data.hourly['Hour'].nunique() }}
                {% else %}
                    0
                {% endif %}
            </div>
            <div class="metric-label">Active Hours</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%);">
            <div class="metric-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="metric-value">
                {% if time_data.hourly is defined and not time_data.hourly.empty %}
                    {{ time_data.hourly['Branch'].nunique() }}
                {% else %}
                    0
                {% endif %}
            </div>
            <div class="metric-label">Branches Analyzed</div>
        </div>
    </div>
</div>

<!-- Hourly Analysis -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üî• Heatmap Penjualan per Jam per Cabang</h5>
            </div>
            <div class="chart-body">
                <div id="hourly-heatmap-chart"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üìà Rata-rata Penjualan per Jam</h5>
            </div>
            <div class="chart-body">
                <div id="hourly-average-chart"></div>
            </div>
        </div>
    </div>
</div>

<!-- Daily and Monthly Pattern Analysis -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üìä Total Penjualan per Hari dalam Seminggu</h5>
            </div>
            <div class="chart-body">
                <div id="daily-pattern-chart"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üìÖ Trend Penjualan Bulanan</h5>
                <small class="text-muted">Berdasarkan periode data aktual</small>
            </div>
            <div class="chart-body">
                <div id="monthly-trend-chart"></div>
            </div>
        </div>
    </div>
</div>

<!-- Peak Hours Analysis -->
{% if time_data.hourly is defined and not time_data.hourly.empty %}
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">‚è∞ Analisis Jam Puncak per Cabang</h5>
            </div>
            <div class="chart-body">
                <div class="table-responsive">
                    <table class="table" id="peakHoursTable">
                        <thead>
                            <tr>
                                <th>Cabang</th>
                                <th>Jam Puncak</th>
                                <th>Revenue Jam Puncak</th>
                                <th>Jam Sepi</th>
                                <th>Revenue Jam Sepi</th>
                                <th>Peak vs Low Ratio</th>
                                <th>Operational Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for branch in time_data.hourly['Branch'].unique() %}
                            {% set branch_data = time_data.hourly[time_data.hourly['Branch'] == branch] %}
                            {% if not branch_data.empty %}
                                {% set peak_hour_data = branch_data.loc[branch_data['Total'].idxmax()] %}
                                {% set low_hour_data = branch_data.loc[branch_data['Total'].idxmin()] %}
                                <tr>
                                    <td>
                                        <strong>{{ branch[:25] }}{% if branch|length > 25 %}...{% endif %}</strong>
                                    </td>
                                    <td>
                                        <span class="badge status-excellent">{{ peak_hour_data['Hour'] }}:00</span>
                                    </td>
                                    <td>{{ peak_hour_data['Total'] | currency }}</td>
                                    <td>
                                        <span class="badge status-fair">{{ low_hour_data['Hour'] }}:00</span>
                                    </td>
                                    <td>{{ low_hour_data['Total'] | currency }}</td>
                                    <td>
                                        {% set ratio = peak_hour_data['Total'] / low_hour_data['Total'] if low_hour_data['Total'] > 0 else 0 %}
                                        <span class="badge {% if ratio > 5 %}status-poor{% elif ratio > 3 %}status-fair{% else %}status-good{% endif %}">
                                            {{ ratio | round(1) }}x
                                        </span>
                                    </td>
                                    <td>
                                        {% set active_hours = branch_data[branch_data['Total'] > 0]['Hour'].nunique() %}
                                        {{ active_hours }} hours
                                    </td>
                                </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üìä Distribusi Jam Puncak</h5>
            </div>
            <div class="chart-body">
                <div id="peak-hours-distribution-chart"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Time Insights and Recommendations -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üîç Insights Pola Waktu</h5>
            </div>
            <div class="chart-body">
                {% if time_data.daily_pattern is defined and not time_data.daily_pattern.empty %}
                    {% set daily_totals = time_data.daily_pattern.groupby('Day_of_Week')['Total_Revenue'].sum() %}
                    {% if not daily_totals.empty %}
                        {% set best_day = daily_totals.idxmax() %}
                        {% set worst_day = daily_totals.idxmin() %}
                    {% else %}
                        {% set best_day = 'N/A' %}
                        {% set worst_day = 'N/A' %}
                    {% endif %}
                {% else %}
                    {% set best_day = 'N/A' %}
                    {% set worst_day = 'N/A' %}
                    {% set daily_totals = {} %}
                {% endif %}
                
                {% if time_data.hourly is defined and not time_data.hourly.empty %}
                    {% set peak_hours = time_data.hourly.loc[time_data.hourly.groupby('Branch')['Total'].idxmax()] %}
                    {% if not peak_hours.empty %}
                        {% set common_peak = peak_hours['Hour'].mode().iloc[0] %}
                    {% else %}
                        {% set common_peak = 'N/A' %}
                    {% endif %}
                {% else %}
                    {% set common_peak = 'N/A' %}
                    {% set peak_hours = [] %}
                {% endif %}
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-calendar-alt me-2"></i>Pola Harian</h6>
                    <ul class="mb-0">
                        <li><strong>Hari Terbaik:</strong> {{ best_day }}