{% extends "base.html" %}

{% block title %}Analisis Produk - Multi-Branch Analytics{% endblock %}

{% block page_title %}üì¶ Analisis Produk Multi-Cabang{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item active">Analisis Produk</li>
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="metric-value">
                {% if product_data is not none and not product_data.empty %}
                    {{ product_data['Menu'].nunique() }}
                {% else %}
                    0
                {% endif %}
            </div>
            <div class="metric-label">Total Produk</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%);">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-value">
                {% if top_products is not none and not top_products.empty %}
                    {{ (top_products['Total'].sum() / 1000000) | round(1) }}M
                {% else %}
                    0M
                {% endif %}
            </div>
            <div class="metric-label">Total Revenue</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);">
            <div class="metric-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="metric-value">
                {% if top_products is not none and not top_products.empty %}
                    {{ top_products['Margin_Percentage'].mean() | round(1) }}%
                {% else %}
                    0%
                {% endif %}
            </div>
            <div class="metric-label">Avg Margin %</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%);">
            <div class="metric-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="metric-value">
                {% if product_data is not none and not product_data.empty %}
                    {{ product_data['Branch'].nunique() }}
                {% else %}
                    0
                {% endif %}
            </div>
            <div class="metric-label">Cabang Analyzed</div>
        </div>
    </div>
</div>

<!-- Top Products Charts -->
{% if charts %}
<div class="row mb-4">
    {% if charts.top_revenue %}
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üí∞ Top 15 Produk by Revenue</h5>
            </div>
            <div class="chart-body">
                <div id="top-revenue-chart"></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if charts.top_quantity %}
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üì¶ Top 15 Produk by Quantity</h5>
            </div>
            <div class="chart-body">
                <div id="top-quantity-chart"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Product Performance Summary -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üèÜ Top 10 Best Performers</h5>
            </div>
            <div class="chart-body">
                {% if top_products is not none and not top_products.empty %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Produk</th>
                                <th>Revenue</th>
                                <th>Quantity</th>
                                <th>Margin %</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range([10, top_products|length]|min) %}
                                {% set product = top_products.iloc[i] %}
                                <tr>
                                    <td>
                                        {% if i < 3 %}
                                            <span class="badge status-excellent">#{{ i + 1 }}</span>
                                        {% elif i < 7 %}
                                            <span class="badge status-good">#{{ i + 1 }}</span>
                                        {% else %}
                                            <span class="badge status-fair">#{{ i + 1 }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ product.Menu[:30] }}{% if product.Menu|length > 30 %}...{% endif %}</strong>
                                    </td>
                                    <td>{{ product.Total | currency }}</td>
                                    <td>{{ product.Qty | number }}</td>
                                    <td>
                                        {% set margin_pct = product.Margin_Percentage %}
                                        {% if margin_pct > 30 %}
                                            <span class="badge status-excellent">{{ margin_pct | percentage }}</span>
                                        {% elif margin_pct > 20 %}
                                            <span class="badge status-good">{{ margin_pct | percentage }}</span>
                                        {% elif margin_pct > 10 %}
                                            <span class="badge status-fair">{{ margin_pct | percentage }}</span>
                                        {% else %}
                                            <span class="badge status-poor">{{ margin_pct | percentage }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if i < 3 and margin_pct > 20 %}
                                            <span class="badge status-excellent">Star Product</span>
                                        {% elif i < 7 and margin_pct > 15 %}
                                            <span class="badge status-good">Good Performer</span>
                                        {% elif margin_pct > 10 %}
                                            <span class="badge status-fair">Average</span>
                                        {% else %}
                                            <span class="badge status-poor">Needs Review</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="text-muted">No product data available</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üí° Product Insights</h5>
            </div>
            <div class="chart-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-chart-pie me-2"></i>Product Distribution</h6>
                    <ul class="mb-0">
                        <li><strong>Total Products:</strong> 
                            {% if product_data is not none and not product_data.empty %}
                                {{ product_data['Menu'].nunique() }}
                            {% else %}
                                0
                            {% endif %}
                        </li>
                        <li><strong>Total Branches:</strong> 
                            {% if product_data is not none and not product_data.empty %}
                                {{ product_data['Branch'].nunique() }}
                            {% else %}
                                0
                            {% endif %}
                        </li>
                        <li><strong>Avg Products per Branch:</strong> 
                            {% if product_data is not none and not product_data.empty %}
                                {{ (product_data.groupby('Branch')['Menu'].nunique().mean()) | round(0) }}
                            {% else %}
                                0
                            {% endif %}
                        </li>
                    </ul>
                </div>
                
                {% if product_data is not none and not product_data.empty %}
                    {% set product_consistency = product_data.groupby('Menu')['Branch'].nunique() %}
                    {% set total_branches = product_data['Branch'].nunique() %}
                    {% set universal_products = (product_consistency == total_branches).sum() %}
                    {% set limited_products = (product_consistency < (total_branches / 2)).sum() %}
                    
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Product Consistency</h6>
                        <ul class="mb-0">
                            <li><strong>Universal Products:</strong> {{ universal_products }} (available in all branches)</li>
                            <li><strong>Limited Products:</strong> {{ limited_products }} (< 50% branches)</li>
                            <li><strong>Avg Availability:</strong> {{ (product_consistency.mean() / total_branches * 100) | round(1) }}%</li>
                        </ul>
                    </div>
                {% endif %}
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Optimization Opportunities</h6>
                    <ul class="mb-0">
                        <li>Standardize popular products across all branches</li>
                        <li>Remove underperforming products</li>
                        <li>Cross-sell high-margin items</li>
                        <li>Optimize pricing strategy</li>
                    </ul>
                </div>
                
                <div class="alert alert-primary">
                    <h6><i class="fas fa-lightbulb me-2"></i>Recommendations</h6>
                    <ol class="mb-0 small">
                        <li>Focus on top 20% products (80/20 rule)</li>
                        <li>Improve marketing for high-margin items</li>
                        <li>Standardize successful products</li>
                        <li>Review pricing of low-margin products</li>
                        <li>Implement upselling strategies</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Analysis by Branch -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üîç Analisis Produk Spesifik per Cabang</h5>
            </div>
            <div class="chart-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="productSelect" class="form-label">Pilih Produk untuk Analisis Detail:</label>
                        <select id="productSelect" class="form-select">
                            <option value="">-- Pilih Produk --</option>
                            {% if product_data is not none and not product_data.empty %}
                                {% for product in product_data['Menu'].unique() %}
                                <option value="{{ product }}">{{ product }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Filter Cabang:</label>
                        <select id="branchFilter" class="form-select">
                            <option value="">Semua Cabang</option>
                            {% if product_data is not none and not product_data.empty %}
                                {% for branch in product_data['Branch'].unique() %}
                                <option value="{{ branch }}">{{ branch }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <div id="product-detail-analysis" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="metric-card" style="background: linear-gradient(135deg, #17a2b8, #138496); padding: 15px;">
                                <div class="metric-value" id="total-revenue-product" style="font-size: 1.2rem;">-</div>
                                <div class="metric-label" style="font-size: 0.8rem;">Total Revenue</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card" style="background: linear-gradient(135deg, #28a745, #1e7e34); padding: 15px;">
                                <div class="metric-value" id="total-qty-product" style="font-size: 1.2rem;">-</div>
                                <div class="metric-label" style="font-size: 0.8rem;">Total Quantity</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card" style="background: linear-gradient(135deg, #ffc107, #e0a800); padding: 15px;">
                                <div class="metric-value" id="avg-margin-product" style="font-size: 1.2rem;">-</div>
                                <div class="metric-label" style="font-size: 0.8rem;">Avg Margin %</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card" style="background: linear-gradient(135deg, #dc3545, #bd2130); padding: 15px;">
                                <div class="metric-value" id="branches-available" style="font-size: 1.2rem;">-</div>
                                <div class="metric-label" style="font-size: 0.8rem;">Branches Available</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="product-comparison-chart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üìä Quick Stats</h5>
            </div>
            <div class="chart-body">
                <div class="alert alert-primary">
                    <h6><i class="fas fa-info-circle me-2"></i>Analysis Overview</h6>
                    <ul class="mb-0">
                        <li>Select a product to see detailed branch analysis</li>
                        <li>Compare performance across branches</li>
                        <li>Identify optimization opportunities</li>
                        <li>Find standardization gaps</li>
                    </ul>
                </div>
                
                <div class="alert alert-success">
                    <h6><i class="fas fa-star me-2"></i>Top Performers</h6>
                    {% if top_products is not none and not top_products.empty %}
                        {% for i in range([3, top_products|length]|min) %}
                            {% set product = top_products.iloc[i] %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><strong>{{ loop.index }}. {{ product.Menu[:20] }}{% if product.Menu|length > 20 %}...{% endif %}</strong></span>
                                <span class="badge status-excellent">{{ product.Total | currency }}</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="mb-0 text-muted">No product data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Performance Ranking Table -->
{% if top_products is not none and not top_products.empty %}
<div class="row">
    <div class="col-12">
        <div class="data-table">
            <div class="chart-header">
                <h5 class="chart-title">üìã Ranking Performa Produk Detail</h5>
            </div>
            <div class="table-responsive">
                <table class="table" id="productTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Produk</th>
                            <th>Total Revenue</th>
                            <th>Total Quantity</th>
                            <th>Total Margin</th>
                            <th>Margin %</th>
                            <th>Avg Price</th>
                            <th>Branches Available</th>
                            <th>Revenue per Branch</th>
                            <th>Performance Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(top_products|length) %}
                            {% set product = top_products.iloc[i] %}
                            {% if product_data is not none and not product_data.empty %}
                                {% set product_branches = product_data[product_data['Menu'] == product.Menu]['Branch'].nunique() %}
                            {% else %}
                                {% set product_branches = 0 %}
                            {% endif %}
                            {% set avg_price = product.Total / product.Qty if product.Qty > 0 else 0 %}
                            {% set revenue_per_branch = product.Total / product_branches if product_branches > 0 else 0 %}
                            <tr>
                                <td>
                                    {% if i < 5 %}
                                        <span class="badge status-excellent">#{{ i + 1 }}</span>
                                    {% elif i < 10 %}
                                        <span class="badge status-good">#{{ i + 1 }}</span>
                                    {% else %}
                                        <span class="badge status-fair">#{{ i + 1 }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ product.Menu[:30] }}{% if product.Menu|length > 30 %}...{% endif %}</strong>
                                </td>
                                <td>
                                    <strong>{{ product.Total | currency }}</strong>
                                    {% if top_products['Total'].sum() > 0 %}
                                    <br>
                                    <small class="text-muted">
                                        {{ ((product.Total / top_products['Total'].sum()) * 100) | round(1) }}% of total
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ product.Qty | number }}</strong>
                                    {% if top_products['Qty'].sum() > 0 %}
                                    <br>
                                    <small class="text-muted">
                                        {{ ((product.Qty / top_products['Qty'].sum()) * 100) | round(1) }}% of total
                                    </small>
                                    {% endif %}
                                </td>
                                <td>{{ product.Margin | currency }}</td>
                                <td>
                                    {% set margin_pct = product.Margin_Percentage %}
                                    {% if margin_pct > 30 %}
                                        <span class="badge status-excellent">{{ margin_pct | percentage }}</span>
                                    {% elif margin_pct > 20 %}
                                        <span class="badge status-good">{{ margin_pct | percentage }}</span>
                                    {% elif margin_pct > 10 %}
                                        <span class="badge status-fair">{{ margin_pct | percentage }}</span>
                                    {% else %}
                                        <span class="badge status-poor">{{ margin_pct | percentage }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ avg_price | currency }}</td>
                                <td>
                                    {% if product_data is not none and not product_data.empty %}
                                        {% set total_branches = product_data['Branch'].nunique() %}
                                        {% if product_branches == total_branches %}
                                            <span class="badge status-excellent">{{ product_branches }} / {{ total_branches }}</span>
                                        {% elif product_branches >= (total_branches * 0.75) %}
                                            <span class="badge status-good">{{ product_branches }} / {{ total_branches }}</span>
                                        {% else %}
                                            <span class="badge status-fair">{{ product_branches }} / {{ total_branches }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge status-fair">0 / 0</span>
                                    {% endif %}
                                </td>
                                <td>{{ revenue_per_branch | currency }}</td>
                                <td>
                                    {% set margin_pct = product.Margin_Percentage %}
                                    {% if i < 5 and margin_pct > 20 %}
                                        <span class="badge status-excellent">Star Product</span>
                                    {% elif i < 10 and margin_pct > 15 %}
                                        <span class="badge status-good">Good Performer</span>
                                    {% elif margin_pct > 10 %}
                                        <span class="badge status-fair">Average</span>
                                    {% else %}
                                        <span class="badge status-poor">Needs Review</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    #product-detail-analysis {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .table td, .table th {
        vertical-align: middle;
    }
    
    .alert {
        border-radius: 8px;
        border: none;
    }
    
    .alert h6 {
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        margin-bottom: 30px;
        overflow: hidden;
        border: 1px solid #e9ecef;
    }
    
    .chart-header {
        background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px 25px;
        border-bottom: 2px solid var(--primary-color, #005A5B);
    }
    
    .chart-title {
        margin: 0;
        color: var(--primary-color, #005A5B);
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .metric-card {
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .metric-card .metric-value {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 5px;
        position: relative;
        z-index: 2;
    }
    
    .metric-card .metric-label {
        font-size: 0.95rem;
        opacity: 0.9;
        font-weight: 500;
        position: relative;
        z-index: 2;
    }
    
    .metric-card .metric-icon {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 2.5rem;
        opacity: 0.3;
        z-index: 1;
    }
    
    .status-excellent { background: #32CD32; }
    .status-good { background: #20B2AA; }
    .status-fair { background: #FF8C00; }
    .status-poor { background: #DC143C; }
    
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.8rem;
    }
    
    .data-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initializeProductCharts();
    
    // Initialize product analysis
    initializeProductAnalysis();
    
    // Initialize DataTable
    const productTable = document.getElementById('productTable');
    if (productTable) {
        $('#productTable').DataTable({
            "pageLength": 20,
            "order": [[ 0, "asc" ]],
            "columnDefs": [
                { "orderable": false, "targets": [9] }
            ],
            "language": {
                "search": "Cari produk:",
                "lengthMenu": "Tampilkan _MENU_ produk per halaman",
                "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ produk",
                "paginate": {
                    "first": "Pertama",
                    "last": "Terakhir",
                    "next": "Selanjutnya",
                    "previous": "Sebelumnya"
                }
            }
        });
    }
});

function initializeProductCharts() {
    // Top Revenue Chart
    {% if charts and charts.top_revenue %}
    try {
        const topRevenueData = {{ charts.top_revenue | safe }};
        Plotly.newPlot('top-revenue-chart', topRevenueData.data, topRevenueData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (error) {
        console.error('Error loading top revenue chart:', error);
    }
    {% endif %}
    
    // Top Quantity Chart
    {% if charts and charts.top_quantity %}
    try {
        const topQuantityData = {{ charts.top_quantity | safe }};
        Plotly.newPlot('top-quantity-chart', topQuantityData.data, topQuantityData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (error) {
        console.error('Error loading top quantity chart:', error);
    }
    {% endif %}
}

function initializeProductAnalysis() {
    const productSelect = document.getElementById('productSelect');
    const branchFilter = document.getElementById('branchFilter');
    const detailAnalysis = document.getElementById('product-detail-analysis');
    
    if (!productSelect || !branchFilter || !detailAnalysis) {
        console.log('Product analysis elements not found, skipping initialization');
        return;
    }
    
    // Product data for analysis
    {% if product_data is not none and not product_data.empty %}
    const productData = {{ product_data.to_dict('records') | safe }};
    {% else %}
    const productData = [];
    {% endif %}
    
    productSelect.addEventListener('change', function() {
        const selectedProduct = this.value;
        if (selectedProduct && productData.length > 0) {
            showProductDetails(selectedProduct, productData);
            detailAnalysis.style.display = 'block';
        } else {
            detailAnalysis.style.display = 'none';
        }
    });
    
    branchFilter.addEventListener('change', function() {
        const selectedProduct = productSelect.value;
        if (selectedProduct && productData.length > 0) {
            showProductDetails(selectedProduct, productData);
        }
    });
}

function showProductDetails(productName, allData) {
    const branchFilter = document.getElementById('branchFilter');
    if (!branchFilter || allData.length === 0) {
        return;
    }
    
    const branchFilterValue = branchFilter.value;
    
    // Filter data for selected product
    let productData = allData.filter(item => item.Menu === productName);
    
    // Apply branch filter if selected
    if (branchFilterValue) {
        productData = productData.filter(item => item.Branch === branchFilterValue);
    }
    
    if (productData.length === 0) {
        return;
    }
    
    // Calculate product metrics
    const totalRevenue = productData.reduce((sum, item) => sum + (item.Total || 0), 0);
    const totalQty = productData.reduce((sum, item) => sum + (item.Qty || 0), 0);
    const totalMargin = productData.reduce((sum, item) => sum + (item.Margin || 0), 0);
    const avgMargin = totalRevenue > 0 ? (totalMargin / totalRevenue * 100) : 0;
    const branchesAvailable = productData.length;
    
    // Update metric cards
    document.getElementById('total-revenue-product').textContent = formatCurrency(totalRevenue);
    document.getElementById('total-qty-product').textContent = formatNumber(totalQty);
    document.getElementById('avg-margin-product').textContent = avgMargin.toFixed(1) + '%';
    document.getElementById('branches-available').textContent = branchesAvailable;
    
    // Create product comparison chart
    createProductComparisonChart(productData, productName);
}

function createProductComparisonChart(productData, productName) {
    if (productData.length === 0) {
        return;
    }
    
    // Prepare data for chart
    const branches = productData.map(item => item.Branch || 'Unknown');
    const revenues = productData.map(item => item.Total || 0);
    const quantities = productData.map(item => item.Qty || 0);
    const margins = productData.map(item => item.Margin_Percentage || 0);
    
    const chartData = [
        {
            x: branches,
            y: revenues,
            type: 'bar',
            name: 'Revenue',
            yaxis: 'y',
            marker: { color: '#1f77b4' }
        },
        {
            x: branches,
            y: margins,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Margin %',
            yaxis: 'y2',
            line: { color: '#ff7f0e', width: 3 },
            marker: { size: 8 }
        }
    ];
    
    const layout = {
        title: `Performa ${productName} per Cabang`,
        xaxis: { 
            title: 'Cabang',
            tickangle: 45
        },
        yaxis: {
            title: 'Revenue (Rp)',
            side: 'left',
            tickformat: ',.0f'
        },
        yaxis2: {
            title: 'Margin (%)',
            side: 'right',
            overlaying: 'y',
            tickformat: '.1f'
        },
        margin: { t: 50, l: 80, r: 80, b: 120 },
        height: 400,
        showlegend: true
    };
    
    try {
        Plotly.newPlot('product-comparison-chart', chartData, layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (error) {
        console.error('Error creating product comparison chart:', error);
    }
}

// Utility functions
function formatCurrency(value) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(value || 0);
}

function formatNumber(value) {
    return new Intl.NumberFormat('id-ID').format(value || 0);
}
</script>
{% endblock %}