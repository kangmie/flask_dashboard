{% extends "base.html" %}

{% block title %}Analisis Produk - Multi-Branch Analytics{% endblock %}
{% block page_title %}üì¶ Analisis Produk Multi-Cabang{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item active">Analisis Produk</li>
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="metric-card">
      <div class="metric-icon"><i class="fas fa-boxes"></i></div>
      <div class="metric-value">
        {% if product_data is not none and not product_data.empty %}
          {{ product_data['Menu'].nunique() }}
        {% else %}0{% endif %}
      </div>
      <div class="metric-label">Total Produk Unik</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="metric-card" style="background:linear-gradient(135deg,#FF8C00 0%,#FFA500 100%);">
      <div class="metric-icon"><i class="fas fa-chart-line"></i></div>
      <div class="metric-value">
        {% if top_products is not none and not top_products.empty %}
          {{ (top_products['Total'].sum() / 1000000) | round(1) }}M
        {% else %}0M{% endif %}
      </div>
      <div class="metric-label">Total Revenue</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="metric-card" style="background:linear-gradient(135deg,#32CD32 0%,#228B22 100%);">
      <div class="metric-icon"><i class="fas fa-percentage"></i></div>
      <div class="metric-value">
        {% if top_products is not none and not top_products.empty %}
          {{ top_products['Margin_Percentage'].mean() | round(1) }}%
        {% else %}0%{% endif %}
      </div>
      <div class="metric-label">Avg Margin %</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="metric-card" style="background:linear-gradient(135deg,#9370DB 0%,#8A2BE2 100%);">
      <div class="metric-icon"><i class="fas fa-building"></i></div>
      <div class="metric-value">
        {% if product_data is not none and not product_data.empty %}
          {{ product_data['Branch'].nunique() }}
        {% else %}0{% endif %}
      </div>
      <div class="metric-label">Cabang Analyzed</div>
    </div>
  </div>
</div>

<!-- Main Analysis - Top Performers per Branch -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="chart-card">
      <div class="chart-header"><h5 class="chart-title">üèÜ Top Performers per Cabang</h5></div>
      <div class="chart-body">
        <div class="row mb-3 g-3">
          <div class="col-md-4">
            <label for="branchSelect" class="form-label">Pilih Cabang:</label>
            <select id="branchSelect" class="form-select">
              <option value="">-- Pilih Cabang Terlebih Dahulu --</option>
              {% if product_data is not none and not product_data.empty %}
                {% for branch in product_data['Branch'].unique() %}
                  <option value="{{ branch }}">{{ branch }}</option>
                {% endfor %}
              {% endif %}
            </select>
            <div class="text-muted mt-1">‚ö†Ô∏è Setiap cabang memiliki menu yang berbeda</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Jumlah Top Products:</label>
            <select id="topCount" class="form-select">
              <option value="10" selected>Top 10</option>
              <option value="15">Top 15</option>
              <option value="20">Top 20</option>
              <option value="25">Top 25</option>
              <option value="50">Top 50</option>
              <option value="all">Tampilkan Semua</option>
            </select>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="showFullNames">
              <label class="form-check-label" for="showFullNames">Tampilkan nama produk lengkap</label>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Sorting:</label>
            <select id="sortBy" class="form-select">
              <option value="revenue" selected>By Revenue</option>
              <option value="quantity">By Quantity</option>
              <option value="margin">By Margin %</option>
            </select>
          </div>
        </div>

        <div id="top-performers-table">
          <div class="alert alert-warning text-center">
            <h6><i class="fas fa-info-circle me-2"></i>Pilih Cabang Terlebih Dahulu</h6>
            <p class="mb-0">Setiap cabang memiliki menu yang unik dan berbeda.<br>Silakan pilih cabang dari dropdown di atas untuk melihat top performers spesifik cabang tersebut.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="chart-card">
      <div class="chart-header"><h5 class="chart-title">üìä Branch Selection Info</h5></div>
      <div class="chart-body">
        <div id="current-selection-info">
          <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notice</h6>
            <p id="selection-text">Setiap cabang memiliki menu yang UNIK dan BERBEDA</p>
            <ul id="selection-stats" class="mb-0">
              <li><strong>Total Unique Products:</strong> <span id="stat-products">{{ product_data['Menu'].nunique() if product_data is not none and not product_data.empty else 0 }}</span></li>
              <li><strong>Total Records:</strong> <span id="stat-records">{{ product_data|length if product_data is not none and not product_data.empty else 0 }}</span></li>
              <li><strong>Branches:</strong> <span id="stat-branches">{{ product_data['Branch'].nunique() if product_data is not none and not product_data.empty else 0 }}</span></li>
              <li><strong>Aggregation:</strong> <span class="text-danger">‚ùå TIDAK VALID</span></li>
            </ul>
          </div>
        </div>

        <div class="alert alert-success">
          <h6><i class="fas fa-star me-2"></i>Top Performers Overview</h6>
          <div id="top-performers-summary">
            <p class="mb-2">Ringkasan top performers saat ini:</p>
            <div id="summary-content"><small class="text-muted">Pilih cabang untuk melihat summary spesifik</small></div>
          </div>
        </div>

        <div class="alert alert-primary">
          <h6><i class="fas fa-lightbulb me-2"></i>Business Insights</h6>
          <div class="row">
            <div class="col-md-6">
              <ul class="mb-0">
                <li>Pilih cabang spesifik untuk analisis mendalam</li>
                <li>Urutkan berdasarkan revenue, quantity, atau margin</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="mb-0">
                <li>Perhatikan products yang konsisten di banyak cabang</li>
                <li>Identifikasi menu unggulan per cabang</li>
              </ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Product Analysis by Branch (Simplified: Revenue & Qty only) -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="chart-card">
      <div class="chart-header"><h5 class="chart-title">üîç Analisis Produk Spesifik</h5></div>
      <div class="chart-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="analysisProduct" class="form-label">Pilih Produk untuk Analisis Detail:</label>
            <select id="analysisProduct" class="form-select" disabled>
              <option value="">-- Pilih cabang terlebih dahulu --</option>
            </select>
            <div class="text-muted mt-1">Dropdown akan aktif setelah cabang dipilih</div>
          </div>
          <div class="col-md-6">
            <label for="productBranchInfo" class="form-label">Branch Information:</label>
            <div id="productBranchInfo" class="form-control-plaintext bg-light rounded p-2 border">
              <i class="fas fa-info-circle text-primary me-2"></i>
              <span id="branchInfoText">Pilih cabang untuk melihat informasi</span>
            </div>
            <div class="text-muted mt-1">Informasi otomatis update sesuai cabang</div>
          </div>
        </div>

        <!-- KPI Only -->
        <div id="product-detail-analysis" style="display: none;">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="metric-card" style="background:linear-gradient(135deg,#17a2b8,#138496); padding:15px;">
                <div class="metric-value" id="total-revenue-product" style="font-size:1.4rem;">-</div>
                <div class="metric-label" style="font-size:0.85rem;">Total Revenue</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="metric-card" style="background:linear-gradient(135deg,#28a745,#1e7e34); padding:15px;">
                <div class="metric-value" id="total-qty-product" style="font-size:1.4rem;">-</div>
                <div class="metric-label" style="font-size:0.85rem;">Total Quantity</div>
              </div>
            </div>
          </div>
        </div>
        <!-- /KPI Only -->
      </div>
    </div>
  </div>


      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  #product-detail-analysis { animation: fadeIn 0.5s ease-in; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(20px);} to { opacity:1; transform:translateY(0);} }
  .table td,.table th{ vertical-align: middle; }
  .alert{ border-radius:8px; border:none; }
  .alert h6{ margin-bottom:10px; font-weight:600; }
  .chart-card{ background:#fff; border-radius:12px; box-shadow:0 2px 15px rgba(0,0,0,0.08); margin-bottom:30px; overflow:hidden; border:1px solid #e9ecef; }
  .chart-header{ background:linear-gradient(90deg,#f8f9fa 0%,#e9ecef 100%); padding:20px 25px; border-bottom:2px solid var(--primary-color,#005A5B); }
  .chart-title{ margin:0; color:var(--primary-color,#005A5B); font-weight:600; font-size:1.1rem; }
  .metric-card{ border-radius:12px; color:#fff; box-shadow:0 4px 20px rgba(0,0,0,0.1); position:relative; overflow:hidden; }
  .metric-card .metric-value{ font-size:2.2rem; font-weight:700; margin-bottom:5px; position:relative; z-index:2; }
  .metric-card .metric-label{ font-size:0.95rem; opacity:0.9; font-weight:500; position:relative; z-index:2; }
  .metric-card .metric-icon{ position:absolute; top:20px; right:20px; font-size:2.5rem; opacity:0.3; z-index:1; }
  .status-excellent{ background:#32CD32; } .status-good{ background:#20B2AA; } .status-fair{ background:#FF8C00; } .status-poor{ background:#DC143C; }
  .badge{ padding:6px 12px; border-radius:20px; font-weight:500; font-size:0.8rem; }
  #productBranchInfo{ min-height:40px; display:flex; align-items:center; background-color:#f8f9fa !important; }
  .form-control-plaintext{ padding:0.375rem 0.75rem; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){ initializeProductAnalysis(); });

function initializeProductAnalysis() {
  const branchSelect = document.getElementById('branchSelect');
  const topCount     = document.getElementById('topCount');
  const sortBy       = document.getElementById('sortBy');
  const analysisProduct = document.getElementById('analysisProduct');
  const detailAnalysis  = document.getElementById('product-detail-analysis');
  const showFullNames   = document.getElementById('showFullNames');

  if (!branchSelect || !topCount || !sortBy) return;

  {% if product_data is not none and not product_data.empty %}
  const productData = {{ product_data.to_dict('records') | safe }};

  branchSelect.addEventListener('change', function(){
    updateTopPerformersTable(productData);
    updateSelectionInfo(productData);
    updateProductDropdown(productData);
  });
  topCount.addEventListener('change', function(){ if (branchSelect.value) updateTopPerformersTable(productData); });
  sortBy.addEventListener('change', function(){ if (branchSelect.value) updateTopPerformersTable(productData); });
  if (showFullNames) showFullNames.addEventListener('change', function(){ if (branchSelect.value) updateTopPerformersTable(productData); });

  analysisProduct.addEventListener('change', function(){
    const selectedProduct = this.value;
    const selectedBranch  = branchSelect.value;
    if (selectedProduct && selectedBranch) {
      showProductDetails(selectedProduct, selectedBranch, productData);
      if (detailAnalysis) detailAnalysis.style.display = 'block';
    } else {
      if (detailAnalysis) detailAnalysis.style.display = 'none';
    }
  });

  updateSelectionInfo(productData);
  {% else %}
  const productData = [];
  {% endif %}
}

/* Helpers */
function truncateName(name, limit=50, showFull=false){
  if (!name) return '';
  if (showFull || name.length <= limit) return name;
  return name.substring(0,limit) + '‚Ä¶';
}
function num(x){ return Number(x) || 0; }

/* Top performers */
function updateTopPerformersTable(allData){
  const selectedBranch = document.getElementById('branchSelect').value;
  const countRaw = document.getElementById('topCount').value;
  const sortBy   = document.getElementById('sortBy').value;
  const tableContainer = document.getElementById('top-performers-table');
  const showFull = document.getElementById('showFullNames')?.checked;

  if (!tableContainer || allData.length === 0) return;

  if (!selectedBranch){
    tableContainer.innerHTML = `
      <div class="alert alert-warning text-center">
        <h6><i class="fas fa-info-circle me-2"></i>Pilih Cabang Terlebih Dahulu</h6>
        <p class="mb-0">Setiap cabang memiliki menu yang unik dan berbeda.<br>Silakan pilih cabang dari dropdown di atas untuk melihat top performers spesifik cabang tersebut.</p>
      </div>`;
    return;
  }

  const branchData = allData.filter(i => i.Branch === selectedBranch);
  if (branchData.length === 0){
    tableContainer.innerHTML = `
      <div class="alert alert-danger text-center">
        <h6><i class="fas fa-exclamation-triangle me-2"></i>No Data</h6>
        <p class="mb-0">No data available for branch: <strong>${selectedBranch}</strong></p>
      </div>`;
    return;
  }

  const productStats = {};
  branchData.forEach(item=>{
    if (!productStats[item.Menu]) productStats[item.Menu] = { Menu:item.Menu, Total:0, Qty:0, Margin:0, branch:selectedBranch };
    productStats[item.Menu].Total += num(item.Total);
    productStats[item.Menu].Qty   += num(item.Qty);
    productStats[item.Menu].Margin+= num(item.Margin);
  });

  const products = Object.values(productStats).map(p=>({
    ...p,
    Margin_Percentage: p.Total>0 ? (p.Margin/p.Total*100) : 0,
    Avg_Price: p.Qty>0 ? (p.Total/p.Qty) : 0
  }));

  let sortField = 'Total';
  if (sortBy==='quantity') sortField='Qty';
  else if (sortBy==='margin') sortField='Margin_Percentage';

  const sorted = products.sort((a,b)=> b[sortField]-a[sortField]);

  const showAll = (countRaw === 'all');
  const count   = showAll ? sorted.length : parseInt(countRaw,10);
  const topProducts = sorted.slice(0,count);

  tableContainer.innerHTML = `
    <div class="table-responsive">
      <table class="table" id="topPerformersTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Produk (${selectedBranch})</th>
            <th>Revenue</th>
            <th>Quantity</th>
            <th>Margin %</th>
            <th>Avg Price</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="topPerformersBody"></tbody>
      </table>
    </div>`;

  const tbody = document.getElementById('topPerformersBody');
  topProducts.forEach((p, idx)=>{
    let rankBadge='status-fair';
    if (idx<3) rankBadge='status-excellent';
    else if (idx<count/2) rankBadge='status-good';

    let marginBadge='status-poor';
    if (p.Margin_Percentage>30) marginBadge='status-excellent';
    else if (p.Margin_Percentage>20) marginBadge='status-good';
    else if (p.Margin_Percentage>10) marginBadge='status-fair';

    let statusBadge='status-poor', statusText='Needs Review';
    if (idx<3 && p.Margin_Percentage>20){ statusBadge='status-excellent'; statusText='Star Product'; }
    else if (idx<count/2 && p.Margin_Percentage>15){ statusBadge='status-good'; statusText='Good Performer'; }
    else if (p.Margin_Percentage>10){ statusBadge='status-fair'; statusText='Average'; }

    const displayName = truncateName(p.Menu, 50, showFull);
    const safeTitle = String(p.Menu||'').replace(/"/g,'&quot;');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="badge ${rankBadge}">#${idx+1}</span></td>
      <td title="${safeTitle}"><strong>${displayName}</strong></td>
      <td>${formatCurrency(p.Total)}</td>
      <td>${formatNumber(p.Qty)}</td>
      <td><span class="badge ${marginBadge}">${p.Margin_Percentage.toFixed(1)}%</span></td>
      <td>${formatCurrency(p.Avg_Price)}</td>
      <td><span class="badge ${statusBadge}">${statusText}</span></td>`;
    tbody.appendChild(tr);
  });

  if (showAll){
    const info = document.createElement('div');
    info.className = 'text-muted mt-2';
    info.innerHTML = '<small>Menampilkan semua produk untuk cabang ini.</small>';
    tableContainer.appendChild(info);
  }

  updateTopPerformersSummary(topProducts, selectedBranch, sortBy);
}

/* Right panel info */
function updateSelectionInfo(allData){
  const selectedBranch = document.getElementById('branchSelect').value;
  const selectionText  = document.getElementById('selection-text');
  const statProducts   = document.getElementById('stat-products');
  const statRecords    = document.getElementById('stat-records');
  const statBranches   = document.getElementById('stat-branches');
  if (!selectionText || allData.length===0) return;

  if (!selectedBranch){
    selectionText.textContent = 'Setiap cabang memiliki menu yang UNIK dan BERBEDA';
    if (statProducts) statProducts.textContent = 'N/A';
    if (statRecords)  statRecords.textContent  = 'N/A';
    if (statBranches) statBranches.textContent = 'N/A';
    return;
  }

  const branchData = allData.filter(i=>i.Branch===selectedBranch);
  const uniqueProducts = new Set(branchData.map(i=>i.Menu)).size;

  selectionText.textContent = `Menampilkan menu spesifik untuk: ${selectedBranch}`;
  if (statProducts) statProducts.textContent = uniqueProducts;
  if (statRecords)  statRecords.textContent  = branchData.length;
  if (statBranches) statBranches.textContent = '1 (Selected)';
}

function updateTopPerformersSummary(topProducts, selectedBranch, sortBy){
  const el = document.getElementById('summary-content');
  if (!el || !selectedBranch){
    if (el) el.innerHTML = '<div class="text-muted">Pilih cabang untuk melihat summary</div>';
    return;
  }
  if (topProducts.length===0){
    el.innerHTML = '<div class="text-danger">No products found for selected branch</div>';
    return;
  }

  const top3 = topProducts.slice(0,3);
  const totalRevenue = topProducts.reduce((s,p)=>s+p.Total,0);
  const avgMargin    = topProducts.reduce((s,p)=>s+p.Margin_Percentage,0)/topProducts.length;
  const sortText = sortBy==='revenue' ? 'revenue' : sortBy==='quantity' ? 'quantity' : 'margin';

  el.innerHTML = `
    <div>
      <p class="mb-2"><strong>Top 3 by ${sortText} di ${selectedBranch}:</strong></p>
      <ol class="mb-3">
        ${top3.map(p=>`<li>${(p.Menu||'').substring(0,30)}${(p.Menu||'').length>30?'‚Ä¶':''}</li>`).join('')}
      </ol>
      <div class="row">
        <div class="col-md-6">
          <ul class="mb-0">
            <li><strong>Total Revenue:</strong> ${formatCurrency(totalRevenue)}</li>
            <li><strong>Avg Margin:</strong> ${avgMargin.toFixed(1)}%</li>
          </ul>
        </div>
        <div class="col-md-6">
          <ul class="mb-0">
            <li><strong>Products Analyzed:</strong> ${topProducts.length}</li>
            <li><strong>Branch-Specific:</strong> <span class="text-success">‚úÖ Valid</span></li>
          </ul>
        </div>
      </div>
    </div>`;
}

/* Dropdown Produk */
function updateProductDropdown(allData){
  const selectedBranch = document.getElementById('branchSelect').value;
  const analysisProduct= document.getElementById('analysisProduct');
  const branchInfoText = document.getElementById('branchInfoText');

  if (!analysisProduct || !selectedBranch){
    analysisProduct.innerHTML = '<option value="">-- Pilih cabang terlebih dahulu --</option>';
    analysisProduct.disabled = true;
    if (branchInfoText) branchInfoText.innerHTML = '<i class="fas fa-info-circle text-primary me-2"></i>Pilih cabang untuk melihat informasi';
    return;
  }

  const branchData = allData.filter(i=>i.Branch===selectedBranch);
  const branchProducts = [...new Set(branchData.map(i=>i.Menu))].sort();

  analysisProduct.innerHTML = '<option value="">-- Pilih produk untuk analisis detail --</option>';
  branchProducts.forEach(product=>{
    const opt = document.createElement('option');
    opt.value = product;
    opt.textContent = product.length>60 ? product.substring(0,60)+'‚Ä¶' : product;
    analysisProduct.appendChild(opt);
  });

  analysisProduct.disabled = false;

  if (branchInfoText){
    branchInfoText.innerHTML = `
      <i class="fas fa-store text-success me-2"></i>
      <strong>${selectedBranch}</strong> - ${branchProducts.length} menu tersedia
    `;
  }
}

/* Detail Produk (Revenue & Qty only) */
function showProductDetails(productName, selectedBranch, allData){
  if (!Array.isArray(allData) || allData.length===0 || !selectedBranch) return;
  const items = allData.filter(i=> i.Menu===productName && i.Branch===selectedBranch);
  if (items.length===0) return;

  const totalRevenue = items.reduce((s,x)=> s + (Number(x.Total)||0), 0);
  const totalQty     = items.reduce((s,x)=> s + (Number(x.Qty)||0), 0);

  const revEl = document.getElementById('total-revenue-product');
  const qtyEl = document.getElementById('total-qty-product');
  if (revEl) revEl.textContent = formatCurrency(totalRevenue);
  if (qtyEl) qtyEl.textContent = formatNumber(totalQty);

  const detailAnalysis = document.getElementById('product-detail-analysis');
  if (detailAnalysis) detailAnalysis.style.display = 'block';
}

/* Utilities */
function formatCurrency(value){
  return new Intl.NumberFormat('id-ID',{ style:'currency', currency:'IDR', minimumFractionDigits:0 }).format(value||0);
}
function formatNumber(value){
  return new Intl.NumberFormat('id-ID').format(value||0);
}
</script>
{% endblock %}
