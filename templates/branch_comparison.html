{% extends "base.html" %}

{% block title %}Komparasi Cabang - Multi-Branch Analytics{% endblock %}

{% block page_title %}üè¢ Komparasi Pendapatan Cabang{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item active">Komparasi Cabang</li>
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="metric-value">{{ branch_data.iloc[0]['Branch'][:15] }}{% if branch_data.iloc[0]['Branch']|length > 15 %}...{% endif %}</div>
            <div class="metric-label">Cabang Terbaik</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%);">
            <div class="metric-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="metric-value">{{ (branch_data['Total_Revenue'].max() / branch_data['Total_Revenue'].min()) | round(1) }}x</div>
            <div class="metric-label">Gap Performa</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);">
            <div class="metric-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="metric-value">{{ branch_data['Margin_Percentage'].mean() | round(1) }}%</div>
            <div class="metric-label">Rata-rata Margin</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card" style="background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%);">
            <div class="metric-icon">
                <i class="fas fa-calculator"></i>
            </div>
            <div class="metric-value">{{ branch_data['COGS_Percentage'].mean() | round(1) }}%</div>
            <div class="metric-label">Rata-rata COGS</div>
        </div>
    </div>
</div>

<!-- Charts Row - Only Revenue and Efficiency -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üí∞ Total Revenue per Cabang</h5>
                <small class="text-muted">Data yang sama dengan dashboard overview</small>
            </div>
            <div class="chart-body">
                <div id="revenue-comparison-chart"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üìä Revenue Summary</h5>
            </div>
            <div class="chart-body">
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-success">üèÜ Top 5 Performers</h6>
                        {% for i in range(5) %}
                            {% if i < branch_data|length %}
                                {% set branch = branch_data.iloc[i] %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><strong>{{ branch.Branch[:20] }}{% if branch.Branch|length > 20 %}...{% endif %}</strong></span>
                                    <span class="badge status-excellent">{{ branch.Total_Revenue | currency }}</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <hr class="my-3">
                        
                        <h6 class="text-warning">‚ö†Ô∏è Bottom 5 (Need Attention)</h6>
                        {% for i in range(5) %}
                            {% set idx = branch_data|length - 5 + i %}
                            {% if idx >= 0 and idx < branch_data|length %}
                                {% set branch = branch_data.iloc[idx] %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><strong>{{ branch.Branch[:20] }}{% if branch.Branch|length > 20 %}...{% endif %}</strong></span>
                                    <span class="badge status-fair">{{ branch.Total_Revenue | currency }}</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Efficiency Chart - Full Width -->
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">‚ö° Efisiensi Revenue per Transaksi</h5>
            </div>
            <div class="chart-body">
                <div id="efficiency-chart"></div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="data-table">
            <div class="chart-header">
                <h5 class="chart-title">üìã Analisis Detail per Cabang</h5>
            </div>
            <div class="table-responsive">
                <table class="table" id="branchTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Cabang</th>
                            <th>Total Revenue</th>
                            <th>Margin %</th>
                            <th>COGS %</th>
                            <th>Total Transaksi</th>
                            <th>Avg per Transaksi</th>
                            <th>Revenue per Hari</th>
                            <th>Total Margin</th>
                            <th>Efisiensi Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for _, branch in branch_data.iterrows() %}
                        <tr>
                            <td>
                                {% if branch.Revenue_Rank <= 3 %}
                                    <span class="badge status-excellent">#{{ branch.Revenue_Rank }}</span>
                                {% elif branch.Revenue_Rank <= branch_data|length // 2 %}
                                    <span class="badge status-good">#{{ branch.Revenue_Rank }}</span>
                                {% else %}
                                    <span class="badge status-fair">#{{ branch.Revenue_Rank }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ branch.Branch }}</strong>
                                <br>
                                <small class="text-muted">
                                    Period: {{ branch.Start_Date.strftime('%d/%m') }} - {{ branch.End_Date.strftime('%d/%m') }}
                                </small>
                            </td>
                            <td>
                                <strong>{{ branch.Total_Revenue | currency }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ ((branch.Total_Revenue / branch_data['Total_Revenue'].sum()) * 100) | round(1) }}% of total
                                </small>
                            </td>
                            <td>
                                <span class="badge {% if branch.Margin_Percentage > 25 %}status-excellent{% elif branch.Margin_Percentage > 20 %}status-good{% elif branch.Margin_Percentage > 15 %}status-fair{% else %}status-poor{% endif %}">
                                    {{ branch.Margin_Percentage | percentage }}
                                </span>
                            </td>
                            <td>
                                <span class="badge {% if branch.COGS_Percentage < 30 %}status-excellent{% elif branch.COGS_Percentage < 40 %}status-good{% elif branch.COGS_Percentage < 50 %}status-fair{% else %}status-poor{% endif %}">
                                    {{ branch.COGS_Percentage | percentage }}
                                </span>
                            </td>
                            <td>
                                <strong>{{ branch.Transaction_Count | number }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ (branch.Transaction_Count / ((branch.End_Date - branch.Start_Date).days + 1)) | round(0) }}/day
                                </small>
                            </td>
                            <td>{{ branch.Avg_Transaction | currency }}</td>
                            <td>{{ branch.Revenue_per_Day | currency }}</td>
                            <td>{{ branch.Total_Margin | currency }}</td>
                            <td>
                                {% set efficiency = (100 - branch.COGS_Percentage) %}
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar {% if efficiency > 70 %}bg-success{% elif efficiency > 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ efficiency }}%">
                                        {{ efficiency | round(0) }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Insights and Recommendations -->
<div class="row">
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üîç Key Insights</h5>
            </div>
            <div class="chart-body">
                {% set top_performer = branch_data.iloc[0] %}
                {% set worst_performer = branch_data.iloc[-1] %}
                {% set total_revenue = branch_data['Total_Revenue'].sum() %}
                {% set median_revenue = branch_data['Total_Revenue'].median() %}
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-chart-line me-2"></i>Revenue Analysis</h6>
                    <ul class="mb-0">
                        <li><strong>Top Performer:</strong> {{ top_performer['Branch'] }} ({{ (top_performer['Total_Revenue']/total_revenue*100) | round(1) }}% of total)</li>
                        <li><strong>Performance Gap:</strong> {{ (top_performer['Total_Revenue']/worst_performer['Total_Revenue']) | round(1) }}x difference</li>
                        <li><strong>Revenue Concentration:</strong> Top 3 branches = {{ (branch_data.head(3)['Total_Revenue'].sum()/total_revenue*100) | round(1) }}%</li>
                        <li><strong>Above Median:</strong> {{ (branch_data['Total_Revenue'] > median_revenue).sum() }} branches</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement</h6>
                    <ul class="mb-0">
                        <li><strong>Low Margin Branches:</strong> {{ (branch_data['Margin_Percentage'] < 20).sum() }} branches below 20%</li>
                        <li><strong>High COGS Branches:</strong> {{ (branch_data['COGS_Percentage'] > 40).sum() }} branches above 40%</li>
                        <li><strong>Underperformers:</strong> Bottom 25% need strategic support</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">üí° Strategic Recommendations</h5>
            </div>
            <div class="chart-body">
                <div class="alert alert-success">
                    <h6><i class="fas fa-lightbulb me-2"></i>Immediate Actions</h6>
                    <ol class="mb-0">
                        <li><strong>Best Practice Sharing:</strong> {{ top_performer['Branch'] }} mentors bottom 3 performers</li>
                        <li><strong>COGS Optimization:</strong> Focus on branches with COGS > 40%</li>
                        <li><strong>Operational Audit:</strong> Review processes in underperforming locations</li>
                    </ol>
                </div>
                
                <div class="alert alert-primary">
                    <h6><i class="fas fa-target me-2"></i>Growth Opportunities</h6>
                    <ul class="mb-0">
                        <li><strong>Revenue Potential:</strong> If all branches reach median performance: +{{ ((median_revenue * branch_data|length - total_revenue) / 1000000) | round(0) }}M</li>
                        <li><strong>Margin Improvement:</strong> Target 2-3% margin increase across all branches</li>
                        <li><strong>Standardization:</strong> Implement uniform pricing and portion control</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .progress {
        background-color: #e9ecef;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .progress-bar {
        display: flex;
        flex-direction: column;
        justify-content: center;
        color: white;
        text-align: center;
        white-space: nowrap;
        background-color: #007bff;
        transition: width 0.6s ease;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .alert {
        border-radius: 8px;
        border: none;
    }
    
    .alert h6 {
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .chart-card {
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
        border-radius: 12px;
    }
    
    .chart-header {
        background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px 25px;
        border-bottom: 2px solid var(--primary-color, #005A5B);
    }
    
    .chart-title {
        margin: 0;
        color: var(--primary-color, #005A5B);
        font-weight: 600;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Revenue Comparison Chart - SAMA PERSIS DENGAN DASHBOARD
    {% if charts and charts.revenue_comparison %}
    const revenueComparisonData = {{ charts.revenue_comparison | safe }};
    Plotly.newPlot('revenue-comparison-chart', revenueComparisonData.data, revenueComparisonData.layout, {
        responsive: true,
        displayModeBar: false
    });
    {% endif %}
    
    // Efficiency Chart - Now Full Width
    {% if charts and charts.efficiency %}
    const efficiencyData = {{ charts.efficiency | safe }};
    Plotly.newPlot('efficiency-chart', efficiencyData.data, efficiencyData.layout, {
        responsive: true,
        displayModeBar: false
    });
    {% endif %}
    
    // Make table sortable
    $('#branchTable').DataTable({
        "pageLength": 25,
        "order": [[ 0, "asc" ]],
        "columnDefs": [
            { "orderable": false, "targets": [9] }
        ],
        "language": {
            "search": "Cari cabang:",
            "lengthMenu": "Tampilkan _MENU_ cabang per halaman",
            "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ cabang",
            "paginate": {
                "first": "Pertama",
                "last": "Terakhir",
                "next": "Selanjutnya",
                "previous": "Sebelumnya"
            }
        }
    });
});
</script>
{% endblock %}